---

- name: Setup
  hosts: localhost
  tasks:
    - name: Install base packages
      apt:
        name: "{{ item }}"
        state: present
      become: yes
      with_items:
        - apt-transport-https
        - awscli
        - ca-certificates
        - curl
        - fonts-hack
        - git
        - golang
        - htop
        - jq
        - libappindicator1 # dependency for keybase
        - libgconf-2-4 # dependency for keybase
        - lm-sensors
        - notify-osd
        - openvpn
        - overlay-scrollbar
        - packer
        - pm-utils
        - scala
        - software-properties-common
        - vagrant
        - vim
        - virtualbox
        - zsh
    - name: Add docker repo key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
      become: yes
    - name: Set up Docker repo
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic test
      become: yes
    - name: Install docker
      become: yes
      apt:
        name: docker-ce
        state: present
    - name: Set up startup services
      become: yes
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - docker
    - name: Get the username running the deploy
      local_action: command whoami
      register: running_user_cmd
    - name: Set username fact
      set_fact:
        running_user: "{{ running_user_cmd.stdout }}"
    - name: Create docker group
      group:
        name: docker
        state: present
    - name: Add current user to docker group
      user:
        name: "{{ running_user }}"
        groups:
          - docker
        append: yes
      become: yes
    - name: Add sbt repo key
      apt_key:
        keyserver: hkp://keyserver.ubuntu.com:80
        id: 2EE0EA64E40A89B84B2DF73499E82A75642AC823
      become: yes
    - name: Add sbt repo
      apt_repository:
        repo: deb https://dl.bintray.com/sbt/debian /
      become: yes
    - name: Install sbt
      apt:
        name: sbt
        state: present
      become: yes
    - name: Set up .zshrc
      template:
        src: .zshrc.j2
        dest: ~/.zshrc
    - name: Set up file watch limit for vscode
      lineinfile:
        path: /etc/sysctl.conf
        line: fs.inotify.max_user_watches=524288
        regexp: ^fs\.inotify\.max_user_watches=
      become: yes

